<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Prototype Page - Beta</title>

    <!-- Load Bulma from CDN (consider saving it to repository instead) -->
    <!-- https://bulma.io/ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">

    <!-- Load Font Awesome 5 (free) icons -->
    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>


    <style>
  #tooltip {
    font-weight: 600;
    text-shadow: 0px 0px 2px white;

    fill: orange;
    stroke: black;
  }

  path.land {
    fill: #dddddd;
    stroke: none;
  }

  path.neighborhood {
    fill: none;
    stroke: white;
    stroke-width: 3.5px;
    pointer-events: none;
  }

  path.street {
    fill: none;
    stroke: white;
    stroke-width: 1px;
    pointer-events: none;
  }

  .active {
    stroke: orange !important;
    stroke-width: 1.5px !important;
  }

  circle.symbol {
    fill-opacity: 0.8;

    stroke: white;
    stroke-width: 1px;
  }

  th {
    text-align: right;
  }

  .node {
    font: 10px sans-serif;
  }

  .link {
    stroke: steelblue;
    stroke-opacity: 0.5;
    fill: none;
    pointer-events: none;
  }


 </style>
  </head>

  <body>

  <!-- Page header -->
  <!-- https://bulma.io/documentation/layout/hero/ -->
  <section class="hero is-info is-bold">
    <div class="hero-body">
      <div class="container">
        <h1 class="title">Prototype Page - Beta</h1>
        <h2 class="subtitle">Visualization in d3.js</h2>
      </div>
    </div>
  </section>
  <!-- End page header -->

  <!-- Page navigation -->
  <!-- https://bulma.io/documentation/components/navbar/ -->
  <nav class="navbar is-light" role="navigation" aria-label="main navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item is-active" href="index.html">
          <span class="icon"><i class="fas fa-home"></i></span>
          <span>Home</span>
        </a>

        <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="main-menu">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>

      <div id="main-menu" class="navbar-menu has-text-weight-medium">
        <!-- Left navbar items -->
        <div class="navbar-start">
          <a class="navbar-item" href="dts.html" title="Data">
            <span class="icon"><i class="fas fa-table"></i></span>
            <span>Data</span>
          </a>

          <div class="navbar-item has-dropdown is-hoverable">
            <a class="navbar-link">
              Visualizations
            </a>

            <div class="navbar-dropdown">
              <a class="navbar-item" href="pttpAlpha.html">
                <span class="icon"><i class="fas fa-chart-line"></i></span>
                <span>Prototype-Alpha: non-proportional symbol map in Tableau</span>
              </a>

              <a class="navbar-item" href="pttpBeta1.html">
                <span class="icon"><i class="fas fa-chart-line"></i></span>
                <span>Prototype-Beta1: edge bundling diagram in d3.js</span>
              </a>

              <a class="navbar-item" href="pttpBeta2.html">
                <span class="icon"><i class="fas fa-chart-line"></i></span>
                <span>Prototype-Beta2: non-proportional symbol map in d3.js</span>
              </a>

            </div>
          </div>
        </div>

        <!-- Right navbar items -->
        <div class="navbar-end">
          <a class="navbar-item" href="abt.html" title="About">
            <span class="icon"><i class="fas fa-info-circle"></i></span>
            <span>About</span>
          </a>
        </div>
      </div>
    </div>
  </nav>
  <!-- End page navigation -->

  <section class="section">
    <div class="container">
      <!-- Begin page content -->
      <div class="content">

        <h1 class="title">
          Visualization in d3.js
        </h1>

        <meta charset="utf-8">
        <figure>
          <svg width="1260" height="500" id="vis">
            <g id="basemap"></g>

            <!-- turn off pointer events for certain groups -->
            <g id="streets" pointer-events="none"></g>
            <g id="outline" pointer-events="none"></g>

            <g id="artItems"></g>
            <g id="tooltip" pointer-events="none"></g>
            <g id="details" pointer-events="none"></g>
          </svg>

          <figcaption>
            Source: <a href="https://data.sfgov.org/Culture-and-Recreation/Civic-Art-Collection/7rjr-9n9w">Civic Art Collection</a>
          </figcaption>
        </figure>

        <script src="https://d3js.org/d3.v5.min.js"></script>

<script>

          const svg = d3.select("body").select("svg#vis");

          const g = {
            edgeBunddling: svg.select("g#edgeBunddling"),
            basemap: svg.select("g#basemap"),
            streets: svg.select("g#streets"),
            outline: svg.select("g#outline"),
            artItems: svg.select("g#artItems"),
            tooltip: svg.select("g#tooltip"),
            details: svg.select("g#details")
          };



          const pad = 14;
          const diameter = 500;
          const height = 500;
          const width = 1260;
          const r = 5;
/*
          var diameter = 960,
              radius = diameter / 2,
              innerRadius = radius - 120;

          var cluster = d3.cluster()
              .size([360, innerRadius]);

          var line = d3.radialLine()
              .curve(d3.curveBundle.beta(0.85))
              .radius(function(d) { return d.y; })
              .angle(function(d) { return d.x / 180 * Math.PI; });

          var link = svg.append("g").selectAll(".link"),
              node = svg.append("g").selectAll(".node");
*/




          let artistMap = [];
          var hrData = [];
          let hrMap = [];
          var countMap = [];
          let layerMap = [];
          let nodes = new Set();

          countMap['Root'] = {};
          countMap['Root']['name'] = 'Root';
          countMap['Root']['parent'] = "";
          countMap['Root']['artCount'] = 0;
          nodes.add('Root');

          //Data wrangling ...
          const csv = "Civic_Art_Collection.csv";
          d3.csv(csv, recordArtist).then(makeHierarchyArray).then(drawHierarchyGraph);

          function recordArtist(row) {
            artistName = row['Artist'];
            artistName = artistName.replace(/ and /g, ';');
            artistName = artistName.replace(/, /g, ';');
            artistName = artistName.trim();
            artistNames = artistName.split(";");

            medium = row['Medium'].toLowerCase();;
            medium = medium.replace(/ and /g, ';');
            medium = medium.replace(/, /g, ';');
            medium = medium.trim();
            mediums = medium.split(';');

  //          console.log(artistName + " - " + medium);

            atSet = new Set();
            artistNames.forEach(function addCurrNew(ats) {
              atSet.add(ats);
            });


            mediums.forEach(function addValue(mdm) {
              m = mdm.trim();
              nodes.add(m);
              rootMCount = countMap['Root']['artCount'];
              rootMCount ++;
              countMap['Root']['artCount'] = rootMCount;
              if(countMap[m]) {
                mCount = countMap[m]['artCount'];
                mCount ++;
                countMap[m]['artCount'] = mCount;
              } else {
                countMap[m] = {};
                countMap[m]['name'] = m;
                countMap[m]['parent'] = 'Root';
                countMap[m]['artCount'] = 1;
              }

              const iteratorA = atSet.entries();
              arr = [];
              for (let entry of iteratorA) {
                name = entry[0];

                name = name + "-" + m;
                nodes.add(name);
        //        console.log(name);
                if(countMap[name]) {
                  nCount = countMap[name]['artCount'];
                  nCount ++;
                  countMap[name]['artCount'] = nCount;
                } else {
                  countMap[name] = {};
                  countMap[name]['name'] = name;
                  countMap[name]['parent'] = m;
                  countMap[name]['artCount'] = 1;
                }
                rootMCount = countMap['Root']['artCount'];
                rootMCount ++;
                countMap['Root']['artCount'] = rootMCount;

              }

            });





            return countMap;

          }


          function makeHierarchyArray(data) {

            console.log(countMap);
  /*          console.log("map: " + hrMap.keys());
            for(var k in hrMap) {
              console.log("key: " + k);
              const iterator1 = hrMap[k].entries();
              arr = [];
              for (let entry of iterator1) {
                arr.push(entry);
                hrData.push({
                  name : entry[0],
                  parent : k,
                  count : countMap[entry[0]]
                });

              }

              hrData.push({
                name : k,
                parent : 'Root',
                count : countMap[k]
              });

            }
*/
              i = 0;
            var array = [];
            for(var k in countMap) {

              currName = countMap[k]['name'];

              array.push({
                name : k,
                parent : countMap[k]['parent'],
                artCount : countMap[k]['artCount']
              });


            }
            console.log(array);
debugger

            root = d3.stratify()
              .id(function(row) { return row.name; })
              .parentId(function(row) {
                return row.parent;
              })
            (array);

            console.log(root);





            return Root;
          }

          function tree() { d3.cluster()
            .size([2 * Math.PI, radius - 100])
          }

          function toCartesian(r, theta) {
            return {
              x: r * Math.cos(theta),
              y: r * Math.sin(theta)
            };
          }


          function radialLine() {
            let generator = d3.linkRadial()
              .angle(d => d.theta + Math.PI / 2) // rotate, 0 angle is mapped differently here
              .radius(d => d.radial);

            return generator;
          }


          function drawHierarchyGraph(data) {
  //          const Root = d3.tree(d3.hierarchy(data)
  //    data.sort((a, b) => d3.ascending(a.height, b.height) || d3.ascending(a.data.name, b.data.name));
//.sort((a, b) => d3.ascending(a.height, b.height) || d3.ascending(a.data.name, b.data.name))));


  //    let layout = d3.tree().size([2 * Math.PI, (500 / 2) - 15]);

/*
            const node = svg.append("g")
              .attr("font-family", "sans-serif")
              .attr("font-size", 10)
                .selectAll("g")
                .data(Root.leaves())
                .join("g")
                    .append("text")
                    .attr("dy", "0.31em")
                    .attr("x", d => d.x < Math.PI ? 6 : -6)
                    .attr("text-anchor", d => d.x < Math.PI ? "start" : "end")
                    .attr("transform", d => d.x >= Math.PI ? "rotate(180)" : null)
                    .text(d => d.data.name)  ;


          const link = svg.append("g")
              .attr("stroke", 'blue')
              .attr("fill", "none")
            .selectAll("path")
        //    .data(Root.leaves().flatMap(leaf => leaf.outgoing))
            .data(Root.children)
            .join("path")
              .style("mix-blend-mode", "multiply")
              .attr("d", ([i, o]) => line(i.path(o)))
              .each(function(d) { d.path = this; });

          return svg.node();


*/
/*
  console.log(Root);
  cluster(Root);
console.log(Root.leaves());

link = link
    .data(packageImports(Root.leaves()))
    .enter().append("path")
      .each(function(d) { d.source = d[0], d.target = d[d.length - 1]; })
      .attr("class", "link")
      .attr("d", line);

  node = node
    .data(Root.leaves())
    .enter().append("text")
      .attr("class", "node")
      .attr("dy", "0.31em")
      .attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + (d.y + 8) + ",0)" + (d.x < 180 ? "" : "rotate(180)"); })
      .attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
      .text(function(d) { return d.data.key; });

*/

data.sort(function(a, b) {
   return b.height - a.height || b.count - a.count;
 });

 let layout = d3.cluster().size([2 * Math.PI, (diameter / 2) - pad]);

 layout(data);

 data.each(function(node) {
   node.theta = node.x;
   node.radial = node.y;

   var point = toCartesian(node.radial, node.theta);
   node.x = point.x;
   node.y = point.y;
 });


 let plot = svg.append("g")
    .attr("id", "plot")
    .attr("transform", translate(width / 2, height / 2));

//  drawLinks(plot.append("g"), data.links(), radialLine);
  drawNodes(plot.append("g"), data.descendants(), true);

  return svg.node();






          }

          function drawLinks(g, links, generator) {
            let paths = g.selectAll('path')
              .data(links)
              .enter()
              .append('path')
              .attr('d', generator)
              .attr('class', 'link');
          }

          function drawNodes(g, nodes, raise) {
            let circles = g.selectAll('circle')
              .data(nodes, node => node.data.name)
              .enter()
              .append('circle')
                .attr('r', d => d.r ? d.r : r)
                .attr('cx', d => d.x)
                .attr('cy', d => d.y)
                .attr('id', d => d.data.name)
                .attr('class', 'node');
          }

          function packageImports(nodes) {
            var map = {},
                imports = [];

            // Compute a map from name to node.
            nodes.forEach(function(d) {
              map[d.data.name] = d;
            });

            // For each import, construct a link from the source to target node.
            nodes.forEach(function(d) {
              if (d.data.imports) d.data.imports.forEach(function(i) {
                imports.push(map[d.data.name].path(map[i]));
              });
            });

            return imports;
          }

          function packageHierarchy(classes) {
            map = hrMap;
            function find(name, data) {
              var node = map[name], i;
              if (!node) {
                node = map[name] = data || {name: name, children: []};
                if (name.length) {
                  node.parent = find(name.substring(0, i = name.lastIndexOf(".")));
                  node.parent.children.push(node);
                  node.key = name.substring(i + 1);
                }
              }
              return node;
            }

            classes.forEach(function(d) {
              find(d.name, d);
            });

            return d3.hierarchy(map[""]);
          }




          function packageImports(nodes) {
            var map = {},
            imports = [];

            // Compute a map from name to node.
            nodes.forEach(function(d) {
              map[d.data.name] = d;
            });

            // For each import, construct a link from the source to target node.
            nodes.forEach(function(d) {
              if (d.data.imports) d.data.imports.forEach(function(i) {
                imports.push(map[d.data.name].path(map[i]));
              });
            });

            return imports;
}





          function line() {
            d3.lineRadial()
              .curve(d3.curveBundle.beta(0.85))
              .radius(d => d.y)
              .angle(d => d.x)
          }


          function id(node) {
            return `${node.parent ? id(node.parent) + "." : ""}${node.data.name}`;
          }





          function bilink(Root) {
            const map = new Map(Root.leaves().map(d => [id(d), d]));
            for (const d of Root.leaves()) d.incoming = [], d.outgoing = d.data.imports.map(i => [d, map.get(i)]);
            for (const d of Root.leaves()) for (const o of d.outgoing) o[1].incoming.push(o);
            return Root;
          }













          function translate(x, y) {
            return "translate(" + String(x) + "," + String(y) + ")";
          }
</script>















  <h3>Question: </h3>
  <p> Is there any clustering of artists that use similar materials as medium of art items and how are the artists connected to each other by such similarity?</p>

  <h3>Answer: </h3>
  <p> </p>


  <h3>Encoding: </h3>
  <P> The visualization would be in the edge bundling diagram that the leaves would be artists, and parent node would be mediums/materials. Then artists use same kind of mediums/materials would be with bundled edges.</p>


  <h3>Interactivity: </h3>
  <p> If the user choose to see a type of medium(material), all art item under this category would show up on the geospatial data visualization, that the symbols represents position of the art items.</p>

  <p>Question: The exact question you are trying to answer with this prototype. Your prototype will be evaluated within the context of this question. For example, "is there a visible pattern of [metric] over [time range]" or "how does [some subcategory] compare to [another subcategory]" are good questions. However, "what [category] has the [largest/smallest] value of [some column]" can be answered with simple statistics and not a good question for visualization. For the best results, you should come up with a question first, then the prototype.




 </p>


      </div>
      <!-- End page content -->
    </div>
  </section>

  <!-- Page footer -->
  <!-- https://bulma.io/documentation/layout/footer/ -->
  <footer class="footer">
    <div class="content has-text-centered is-size-7">
      <p>
        <a href="#top">
          <span class="fas fa-arrow-up"></span>
          <span class="has-text-weight-medium">Back to Top</span>
        </a>
      </p>

      <p>
        <a href="https://github.com/usf-cs360-spring2020/project-alexziweiwang" class="button is-small" style="padding-left: 1em; padding-right: 1em;" target = _blank>
          <i class="fab fa-github-alt"></i>&nbsp;<strong>Github</strong>
        </a>

        <a href="https://fontawesome.com/" class="button is-small" style="padding-left: 1em; padding-right: 1em;">
          <i class="fab fa-font-awesome"></i>&nbsp;<strong>FontAwesome</strong>
        </a>

        <a href="https://bulma.io" class="button is-small">
          <img src="https://bulma.io/images/made-with-bulma--semiblack.png" alt="Made with Bulma" width="128" height="24">
        </a>
      </p>
    </div>
  </footer>
  <!-- End page footer -->
  </body>

</html>
